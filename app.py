# -*- coding: utf-8 -*-
"""app.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1eGl3keFLlYPygFu1HyBJ2CXhjQM_IBq_

Streamlit UI (app.py)
"""

import streamlit as st
import pandas as pd
import numpy as np
import matplotlib.pyplot as plt
import logging
from src.data_processor import DataProcessor
from src.code_generator import CodeGenerator
from src.report_generator import ReportGenerator
from src.config import APP_TITLE, MAX_FILE_SIZE_MB, LLM_MODEL

# è¨­å®šlogging
logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

# --- 1. åˆå§‹åŒ– Session State (å°å£è¢‹) ---
# ç¢ºä¿å³ä½¿æŒ‰ä¸‹ã€ŒåŸ·è¡ŒæŒ‰éˆ•ã€å°è‡´æ•´é åˆ·æ–°ï¼Œé€™äº›å…§å®¹ä¹Ÿä¸æœƒå¼„ä¸Ÿ
if "generated_code" not in st.session_state:
    st.session_state.generated_code = ""
if "insights" not in st.session_state:
    st.session_state.insights = ""
if "df" not in st.session_state:
    st.session_state.df = None

# Streamlité é¢è¨­å®š
st.set_page_config(page_title=APP_TITLE, layout="wide")
st.title("ğŸ”§ Manufacturing AI Code & Report Assistant")
st.markdown("ç”¨è‡ªç„¶èªè¨€ç”Ÿæˆè£½é€ æ¥­è³‡æ–™åˆ†æä»£ç¢¼èˆ‡å ±å‘Š")

# Sidebar åƒæ•¸
with st.sidebar:
    st.header("âš™ï¸ è¨­å®š")
    model_choice = st.selectbox(
        "é¸æ“‡LLMæ¨¡å‹",
        ["qwen2.5:0.5b", "local-ollama", "gpt-3.5-turbo"],
        help="å»ºè­° MX110 é¡¯å¡ä½¿ç”¨ 1.5b æ¨¡å‹ä»¥é¿å…å´©æ½°"
    )
    temperature = st.slider("Temperature (å‰µæ„åº¦)", 0.0, 1.0, 0.7)
    st.markdown("---")
    st.info("ğŸ’¡ æ­¥é©Ÿï¼šä¸Šå‚³æª”æ¡ˆ â†’ ç”Ÿæˆä»£ç¢¼ â†’ é»æ“ŠåŸ·è¡Œä»£ç¢¼")

# ä¸»ç¨‹å¼å€
st.markdown("## æ­¥é©Ÿ1: ä¸Šå‚³è³‡æ–™")
uploaded_file = st.file_uploader(
    "ä¸Šå‚³CSVæˆ–Excelæª”æ¡ˆ",
    type=["csv", "xlsx"],
    help=f"æª”æ¡ˆå¤§å°é™åˆ¶: {MAX_FILE_SIZE_MB}MB"
)

if uploaded_file:
    # è®€å–ä¸¦ä¿å­˜è³‡æ–™åˆ° session_state
    if st.session_state.df is None:
        processor = DataProcessor()
        st.session_state.df = processor.load_file(uploaded_file)
        st.success(f"âœ… å·²è®€å– {len(st.session_state.df)} è¡Œ")

    df = st.session_state.df
    st.dataframe(df.head(10))

    st.markdown("## æ­¥é©Ÿ2: è¼¸å…¥åˆ†æéœ€æ±‚")
    user_request = st.text_area(
        "æè¿°ä½ è¦åˆ†æçš„å…§å®¹",
        value="åˆ†ææœ¬é€±è‰¯ç‡è¶¨å‹¢ä¸¦æ‰¾å‡ºTop3ç•°å¸¸å› å­",
        height=80
    )

    st.markdown("## æ­¥é©Ÿ3: AIç”Ÿæˆä»£ç¢¼")
    # ç”ŸæˆæŒ‰éˆ•ï¼šåªè² è²¬ã€Œç”¢ç”Ÿã€å…§å®¹ä¸¦æ”¾å…¥ã€Œå£è¢‹ã€
    if st.button("ğŸš€ ç”Ÿæˆä»£ç¢¼ & å ±å‘Š", type="primary"):
        with st.spinner("AI æ€è€ƒä¸­ (é€™å¯èƒ½éœ€è¦ä¸€é»æ™‚é–“)..."):
            processor = DataProcessor()
            processor.df = df # åŒæ­¥è³‡æ–™
            data_summary = processor.get_summary()
            schema = {col: str(df[col].dtype) for col in df.columns}

            # æ¨¡å‹åç¨±åˆ¤æ–·é‚è¼¯
            final_model = LLM_MODEL if model_choice == "local-ollama" else model_choice
            
            generator = CodeGenerator(model_name=final_model)
            result = generator.generate_code(
                user_request=user_request,
                data_summary=data_summary,
                sample_dataframe_schema=schema
            )
            
            # å°‡çµæœå­˜å…¥ã€Œå£è¢‹ã€
            st.session_state.generated_code = result['code']
            st.session_state.insights = result['insights']

    # --- é—œéµå€åŸŸï¼šé¡¯ç¤ºèˆ‡åŸ·è¡Œ ---
    # åªè¦ã€Œå£è¢‹ã€è£¡æœ‰æ±è¥¿ï¼Œå°±é¡¯ç¤ºå‡ºä¾†
    if st.session_state.generated_code:
        st.subheader("ğŸ“ ç”Ÿæˆçš„Pythonä»£ç¢¼")
        
        # è®“ä½¿ç”¨è€…å¯ä»¥å¾®èª¿ä»£ç¢¼ï¼Œä¿®æ”¹æœƒå³æ™‚åŒæ­¥å›å£è¢‹
        st.session_state.generated_code = st.text_area(
            "ç·¨è¼¯ä»£ç¢¼å€ï¼š",
            value=st.session_state.generated_code,
            height=250
        )

        # é»æ“Šæ­¤æŒ‰éˆ•æœƒè§¸ç™¼æ•´é é‡æ–°åŸ·è¡Œï¼Œä½†å› ç‚ºæˆ‘å€‘ç”¨äº† session_stateï¼Œä»£ç¢¼ä¸æœƒæ¶ˆå¤±
        if st.button("â–¶ï¸ åŸ·è¡Œä»£ç¢¼"):
            st.markdown("### ğŸ“Š åŸ·è¡Œçµæœ")
            try:
                exec_globals = {
                    'df': df, 'pd': pd, 'np': np, 'plt': plt, 'st': st,
                    '__builtins__': __builtins__,  # â† åŠ é€™è¡Œ
                }
                exec_locals = {}  # â† åŠ é€™è¡Œ
                exec(st.session_state.generated_code, exec_globals, exec_locals)  # â† æ”¹é€™è¡Œ
                st.success("âœ… ä»£ç¢¼åŸ·è¡ŒæˆåŠŸ")
            except Exception as e:
                st.error(f"âŒ åŸ·è¡Œå‡ºéŒ¯: {e}")

        # é¡¯ç¤ºæ´å¯Ÿèˆ‡å ±å‘Šä¸‹è¼‰ (å¾å£è¢‹æ‹¿)
        st.subheader("ğŸ’¡ AIæ´å¯Ÿ")
        st.markdown(st.session_state.insights)

        st.subheader("ğŸ“Š å®Œæ•´å ±å‘Šä¸‹è¼‰")
        report_gen = ReportGenerator(title="Manufacturing Analysis Report")
        report_gen.add_section("åˆ†æéœ€æ±‚", user_request)
        report_gen.add_section("ç”Ÿæˆä»£ç¢¼", st.session_state.generated_code, section_type="code")
        report_gen.add_section("ä¸»è¦ç™¼ç¾", st.session_state.insights, section_type="insight")

        c1, c2 = st.columns(2)
        with c1:
            st.download_button("ğŸ“¥ ä¸‹è¼‰Markdown", data=report_gen.generate_markdown(), file_name="report.md")
        with c2:
            st.download_button("ğŸ“¥ ä¸‹è¼‰HTML", data=report_gen.generate_html(), file_name="report.html")

else:
    # å¦‚æœæ¸…ç©ºæª”æ¡ˆï¼Œä¹Ÿè¦æ¸…ç©ºå£è¢‹
    st.session_state.generated_code = ""
    st.session_state.df = None
    st.info("ğŸ‘ˆ è«‹å…ˆä¸Šå‚³CSVæˆ–Excelæª”æ¡ˆ")